<!DOCTYPE html>
<html>
<head>
    <title>HOO YOU KNOW - Company Lookup</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    
</head>
<body>    
    <div class="container">

        <div class="head">
            <h1>HOO YOU KNOW</h1>
            <p>Choose cities and industries to connect with UVA alumni on LinkedIn and grow your network of Hoos.</p>    
        </div>
        
        <div class="subhead">
            <h3>How to Use</h3>
            <ol>
                <li>Select desired city (one or more)</li>
                <li>Select desired industry (one or more)</li>
                <li>Click Find Companies</li>
                <li>Follow the 'UVA Alumni' link to find relevant alumni to connect with</li>
            </ol>
            <i><b>Note: some links may not have any alumni or return an unavailable page. If you encounter a link that does not work, please contact <a href="mailto:ryanlevy830@gmail.com">ryanlevy830@gmail.com</a></b></i><br>
            <a href="https://forms.gle/bBCW13N1eZAxb4S88" target="_blank">Contribute by adding companies, cities, or industries</a>
        </div>

        <div class="filters">

            <div class="filter1">
                <div class="checkbox-group">
                    <h3>Select Cities:</h3>
                    <div id="cityCheckboxes"></div>
                </div>
            </div>

            <div class="filter2"> 
                <div class="checkbox-group">
                    <h3>Select Industries:</h3>
                    <div id="industryCheckboxes"></div>
                </div>
            </div>

            <div class="button">
                <button onclick="showCompanies()">Find Companies</button>
            </div>

         </div>
        

        <br>

        <div class="table">
            <div id="results"></div>
        </div>

        
        <div class="foot">
            <p>footer</p>
        </div>
    </div>

    <script>
        // Global variables for the JSON data
        let companyCodesData, locationCodesData, industryBroadData;

        // Define file paths
        const files = {
        companyCodes: '../json/company_codes_.json',
        locationCodes: '../json/city_code.json',
        industryBroad: '../json/industry_broad.json'
        };

        // Fetch company_codes_.json
        fetch(files.companyCodes)
        .then(response => response.json())
        .then(data => {
            companyCodesData = data;
            populateCheckboxes();
        })
        .catch(error => console.error('Error reading company_codes_.json:', error));

        // Fetch city_code.json
        fetch(files.locationCodes)
        .then(response => response.json())
        .then(data => {
            locationCodesData = data;
            populateCheckboxes();
        })
        .catch(error => console.error('Error reading city_code.json:', error));

        // Fetch industry_broad.json
        fetch(files.industryBroad)
        .then(response => response.json())
        .then(data => {
            industryBroadData = data;
            populateCheckboxes();
        })
        .catch(error => console.error('Error reading industry_broad.json:', error));

        /**
         * populateCheckboxes() waits until all required data is loaded before building the checkboxes.
         * Here, we add a "Select All" checkbox for cities that will act as a flag.
         */
        function populateCheckboxes() {
        if (companyCodesData && locationCodesData && industryBroadData) {
            // --- Build City Checkboxes ---
            // Get the container for city checkboxes
            const cityCheckboxesDiv = document.getElementById('cityCheckboxes');
            cityCheckboxesDiv.innerHTML = ''; // Clear any existing checkboxes

            // Extract the list of cities from companyCodesData (assuming structure: { "USA": { "CityName": { ... } } })
            const cities = Object.keys(companyCodesData['USA']);
            cities.forEach(city => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = city;
            checkbox.id = `city-${city}`;

            const label = document.createElement('label');
            label.htmlFor = `city-${city}`;
            label.textContent = city;

            // Wrap each city checkbox and label in a div for easier styling (optional)
            const wrapper = document.createElement('div');
            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);

            cityCheckboxesDiv.appendChild(wrapper);
            });

            // Create the "Select All" checkbox at the top
            const selectAllWrapper = document.createElement('div');
            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.id = 'citySelectAll';
            // The value of this checkbox isn't used for iterationâ€”it's a flag.
            const selectAllLabel = document.createElement('label');
            selectAllLabel.htmlFor = 'citySelectAll';
            selectAllLabel.textContent = 'Select All';
            selectAllWrapper.appendChild(selectAllCheckbox);
            selectAllWrapper.appendChild(selectAllLabel);
            cityCheckboxesDiv.appendChild(selectAllWrapper);

            // --- Build Industry Checkboxes (unchanged) ---
            // Derive a list of industries from companyCodesData.
            const industries = [
            ...new Set(
                Object.values(companyCodesData['USA'])
                .flatMap(cityObj => Object.keys(cityObj))
            )
            ];

            const industryCheckboxesDiv = document.getElementById('industryCheckboxes');
            industryCheckboxesDiv.innerHTML = '';

            // Create container elements for two columns
            const columnsContainer = document.createElement('div');
            columnsContainer.className = 'industry-columns';

            const leftColumn = document.createElement('div');
            leftColumn.className = 'industry-column';
            const rightColumn = document.createElement('div');
            rightColumn.className = 'industry-column';

            const leftColumnCategories = ['STEM & Technical Fields', 'Government, Law & Public Service'];
            const rightColumnCategories = ['Business & Finance', 'Healthcare & Life Sciences', 'Creative & Cultural Industries'];
            const remainingCategories = Object.keys(industryBroadData)
            .filter(cat => !leftColumnCategories.includes(cat) && !rightColumnCategories.includes(cat));

            const createCategoryDiv = (category) => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'industry-category';

            const header = document.createElement('h3');
            header.textContent = category;
            categoryDiv.appendChild(header);

            industryBroadData[category].forEach(industry => {
                if (industries.includes(industry)) {
                const wrapper = document.createElement('div');
                wrapper.className = 'checkbox-wrapper';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = industry;
                checkbox.id = `industry-${industry}`;

                const label = document.createElement('label');
                label.htmlFor = `industry-${industry}`;
                label.textContent = industry;

                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);
                categoryDiv.appendChild(wrapper);
                }
            });
            return categoryDiv;
            };

            leftColumnCategories.forEach(category => {
            if (industryBroadData[category]) {
                leftColumn.appendChild(createCategoryDiv(category));
            }
            });

            const midpoint = Math.ceil(remainingCategories.length / 2);
            remainingCategories.slice(0, midpoint).forEach(category => {
            leftColumn.appendChild(createCategoryDiv(category));
            });

            rightColumnCategories.forEach(category => {
            if (industryBroadData[category]) {
                rightColumn.appendChild(createCategoryDiv(category));
            }
            });

            remainingCategories.slice(midpoint).forEach(category => {
            rightColumn.appendChild(createCategoryDiv(category));
            });

            columnsContainer.appendChild(leftColumn);
            columnsContainer.appendChild(rightColumn);
            industryCheckboxesDiv.appendChild(columnsContainer);
        }
        }

        /**
         * showCompanies() reads the selected cities and industries, then builds an HTML table of companies.
         * If the "Select All" checkbox (citySelectAll) is checked, it treats all cities as selected.
         */
        function showCompanies() {
        // Check if the "Select All" checkbox is checked
        const selectAllChecked = document.getElementById('citySelectAll')?.checked;

        let selectedCities = [];
        if (selectAllChecked) {
            // If "Select All" is checked, treat all cities as selected.
            selectedCities = Object.keys(companyCodesData['USA']);
        } else {
            // Otherwise, only consider the individually checked city checkboxes.
            selectedCities = Array.from(document.querySelectorAll('#cityCheckboxes input[type="checkbox"]:not(#citySelectAll):checked'))
                                .map(cb => cb.value);
        }

        // Get selected industries from the industry checkboxes
        const selectedIndustries = Array.from(document.querySelectorAll('#industryCheckboxes input:checked')).map(cb => cb.value);

        console.log("Selected Cities:", selectedCities);
        console.log("Selected Industries:", selectedIndustries);

        if (companyCodesData && locationCodesData && selectedCities.length > 0 && selectedIndustries.length > 0) {
            let resultHTML = '<table border="1" style="border-collapse: collapse; width: 50%;">';
            resultHTML += '<tbody>';

            selectedCities.forEach(city => {
            selectedIndustries.forEach(industry => {
                resultHTML += `<tr><td colspan="2" style="background-color: #cae0fc; height: 10px; font-weight: bold;">${industry}: ${city}</td></tr>`;
                console.log(`Fetching data for City: ${city}, Industry: ${industry}`);

                if (companyCodesData['USA'][city] && companyCodesData['USA'][city][industry]) {
                const companies = companyCodesData['USA'][city][industry];
                const cityCode = locationCodesData['Cities'][city];

                console.log("Companies:", companies);
                console.log("City Code:", cityCode);

                companies.forEach(companyObj => {
                    resultHTML += `
                    <tr>
                        <td>
                        <a href="${companyObj.LinkedInURL}/people/?facetGeoRegion=${cityCode}&facetSchool=4298" target="_blank">
                            ${companyObj.Company}
                        </a>
                        </td>
                    </tr>`;
                });
                } else {
                resultHTML += `<tr><td colspan="2">No companies found for this combination.</td></tr>`;
                }
                resultHTML += '<tr><td colspan="2" style="height: 30px;"></td></tr>';
            });
            });

            resultHTML += '</tbody></table>';
            document.getElementById('results').innerHTML = resultHTML;
        } else {
            alert('Please ensure all JSON files are loaded and select at least one city and one industry.');
        }
        }


        
    </script>
</body>
</html>
